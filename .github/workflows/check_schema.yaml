name: Check Schema Changes

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - dev

jobs:
  decide:
    runs-on: ubuntu-latest
    outputs:
      run_production: ${{ steps.decide.outputs.run_production }}
      run_development: ${{ steps.decide.outputs.run_development }}

    steps:
      - name: Decide which schema checks to run
        id: decide
        run: |
          # Defaults for scheduled runs: run both.
          RUN_PROD=true
          RUN_DEV=true

          # For PRs, choose based on target branch.
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.pull_request.base.ref }}" = "main" ]; then
              RUN_PROD=true
              RUN_DEV=false
            elif [ "${{ github.event.pull_request.base.ref }}" = "dev" ]; then
              RUN_PROD=false
              RUN_DEV=true
            else
              RUN_PROD=false
              RUN_DEV=false
            fi
          fi

          echo "run_production=$RUN_PROD" >> $GITHUB_OUTPUT
          echo "run_development=$RUN_DEV" >> $GITHUB_OUTPUT

  schema_checks:
    needs: decide
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - env_name: production
            token_var: GPP_PRODUCTION_TOKEN
            continue_on_error: false
            flag: run_production
          - env_name: development
            token_var: GPP_DEVELOPMENT_TOKEN
            continue_on_error: true
            flag: run_development

    steps:
      - uses: actions/checkout@v5

      # Skip the entire matrix entry if flagged off.
      - name: Skip if not needed
        if: needs.decide.outputs[matrix.flag] != 'true'
        run: |
          echo "Skipping this matrix entry."
          exit 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"

      - name: Install schema dependencies
        run: uv sync --locked --group schema

      - name: Export correct token env var
        run: |
          echo "${{ matrix.token_var }}=${{ secrets[matrix.token_var] }}" >> $GITHUB_ENV

      - name: Download schema (${{ matrix.env_name }})
        env:
          GPP_ENV: ${{ matrix.env_name }}
        run: |
          uv run python scripts/download_schema.py ${{ matrix.env_name }} --output-dir ci_schemas

      - name: Install GraphQL Inspector CI
        run: |
          npm install -g \
            @graphql-inspector/ci \
            @graphql-inspector/diff-command \
            @graphql-inspector/graphql-loader graphql

      - name: Compare schema (${{ matrix.env_name }})
        continue-on-error: ${{ matrix.continue_on_error }}
        run: |
          graphql-inspector diff \
            schemas/${{ matrix.env_name }}.schema.graphql \
            ci_schemas/${{ matrix.env_name }}.schema.graphql
